---
# Godon Optimization Configuration
# Config format version - independent from godon software version
meta:
  configVersion: "0.2"

# Breeder worker configuration
breeder:
  type: "linux_performance"  # Which breeder worker implementation to use

# Parameter search space - Linux kernel tuning knobs to optimize
settings:
  # System Control (proc/sys) - key-value parameters
  sysctl:
    # TCP read buffer sizes - multiple disjoint ranges for parallel exploration
    net.ipv4.tcp_rmem:
      type: "int"
      - {step: 100, lower: 4096, upper: 131072}     # Conservative
      - {step: 100, lower: 262144, upper: 6291456}   # Performance

    # TCP write buffer sizes
    net.ipv4.tcp_wmem:
      type: "int"
      step: 100
      constraints:
        lower: 4096
        upper: 6291456

    # Network device budget - conservative vs aggressive
    net.core.netdev_budget:
      type: "int"
      - {step: 10, lower: 10, upper: 100}
      - {step: 10, lower: 500, upper: 2000}

    # Maximum backlog queue length - disjoint ranges
    net.core.netdev_max_backlog:
      type: "int"
      - {step: 10, lower: 10, upper: 1000}
      - {step: 10, lower: 3000, upper: 5000}

    # CPU weight for network device processing
    net.core.dev_weight:
      type: "int"
      step: 10
      constraints:
        lower: 10
        upper: 2000

  # System Filesystem (sysfs) - use aliases for long paths
  sysfs:
    # CPU frequency scaling governor
    cpu_governor:
      path: "/devices/system/cpu/cpu0/cpufreq/scaling_governor"
      type: "categorical"
      constraints:
        enum: ["performance", "powersave", "ondemand"]

    # Transparent huge pages
    transparent_hugepage:
      path: "/sys/kernel/mm/transparent_hugepage/enabled"
      type: "categorical"
      constraints:
        enum: ["always", "madvise", "never"]

    # Network interface queue discipline
    qdisc:
      path: "/sys/class/net/eth0/queue/disc"
      type: "categorical"
      constraints:
        enum: ["fq", "pfifo_fast", "htb"]

  # CPU Frequency Scaling - structured config
  cpufreq:
    governor:
      type: "categorical"
      constraints:
        enum: ["performance", "powersave", "ondemand", "schedutil"]

    min_freq_ghz:
      type: "discrete_float"
      step: 0.2
      constraints:
        lower: 1.2
        upper: 2.4

    max_freq_ghz:
      type: "discrete_float"
      step: 0.2
      constraints:
        lower: 2.4
        upper: 4.8

  # Network Interface (ethtool) - structured config
  ethtool:
    eth0:
      # TCP Segmentation Offload
      tso:
        type: "categorical"
        constraints:
          enum: ["on", "off"]

      # Generic Receive Offload
      gro:
        type: "categorical"
        constraints:
          enum: ["on", "off"]

      # RX ring buffer size
      rx_ring:
        type: "int"
        step: 512
        constraints:
          lower: 512
          upper: 8192

      # TX ring buffer size
      tx_ring:
        type: "int"
        step: 512
        constraints:
          lower: 512
          upper: 8192

# Execution control
run:
  parallel: 3  # Number of parallel workers

  completion_criteria:
    iterations:
      min: 10  # Minimum trials before considering early stopping
      max: 1000  # Maximum trials before forcing termination
    timing:
      end: "7d"  # Maximum lifetime of the optimization run (e.g., 7d, 24h, 60m)
    quality_achieved: true  # Stop when all quality_threshold objectives are met

cooperation:
  active: true  # Enable shared learning between parallel workers

  # Sharing strategy: "probabilistic", "best", "worst", "extremes"
  share_strategy: "extremes"

  # Quality-based filtering parameters
  top_percentile: 0.2  # Share top 20% of trials
  bottom_percentile: 0.2  # Share bottom 20% of trials
  min_trials_for_filtering: 10  # Wait for 10 trials before quality filtering kicks in

  # Legacy probabilistic sharing
  probability: 0.8  # 80% chance to share each trial

# Optimization objectives
objectives:
  - name: "tcp_rtt"
    direction: minimize  # Minimize round-trip time
    quality_threshold: 50  # Stop when RTT <= 50ms (optional)
    reconnaissance:
      service: prometheus  # Metric source type
      query: "scalar(tcp_rtt * 1000)"  # Prometheus query (converts to milliseconds)
      stabilization_seconds: 10  # Wait period after parameter change before sampling
      samples: 5  # Number of samples to collect
      interval: 2  # Seconds between samples

  - name: "tcp_delivery_rate_bytes"
    direction: maximize  # Maximize delivery rate (throughput)
    quality_threshold: 1048576  # Stop when throughput >= 1MB/s (optional)
    reconnaissance:
      service: prometheus
      query: "scalar(rate(tcp_delivery_rate_bytes[1m]))"
      stabilization_seconds: 10
      samples: 5
      interval: 2

# Parameter application (effectuation) configuration
effectuation:
  targets:
    - type: "ssh"  # Target type (must match breeder's supported types)
      id: "target_1"
      address: "10.0.5.53"  # Target system IP address
      username: "godon_robot"
      credentialName: "godon_ssh_key"  # Credential name from credential catalog
      # Alternatively, use credentialId to reference by UUID:
      # credentialId: "123e4567-e89b-12d3-a456-426614174000"

    - type: "ssh"  # Target type (must match breeder's supported types)
      id: "target_2"
      address: "10.0.5.54"  # Target system IP address
      username: "godon_robot"
      credentialName: "godon_ssh_key"  # Credential name from credential catalog
      # Alternatively, use credentialId to reference by UUID:
      # credentialId: "123e4567-e89b-12d3-a456-426614174000"
